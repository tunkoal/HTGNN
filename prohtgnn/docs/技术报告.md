# 技术报告：HTGNN 在自建异构时态图上的 Protein 节点二分类

## 1. 问题与数据建模

**任务**：在自建异构时态图上对 **protein** 节点进行二分类（重要蛋白质与否）。ground truth 来自 `nodes.csv.function`：`ORF‑V`→1，其余为 0；其他类型不计入监督/评估。`single protein` 与 `protein` 等视并合并。

**图构造**：  
- **节点类型**：`protein`、`GO`、`reaction`（`single protein` 归并到 `protein`）。  
- **时间**：`edges.timeset` 的 37 个唯一端点定义 **36** 个半开时间片 `[t_i,t_{i+1})`（空值=全时段）。解析函数将区间串解析为覆盖的时间片下标。  
- **边**：将覆盖的时间片展开为多个 etype，并对**无向**边补反向；canonical etype 采用 `edge_type_t{idx}` 后缀化（与官方实现一致）。

**特征（直推式）**：  
- **protein**：从 `t0~t35` 读取每片一维表达值（缺失即报错）；  
- **GO/reaction**：训练态**可学习嵌入**（`nn.Embedding`），并在前向时覆盖其所有 `t*` 占位特征；  
- 各类型再经**类型特定线性层**升维到统一隐空间 `d_model`（HTGNN 主干的适配层完成）。

**划分（直推式）**：仅对 **protein** 做 **70%/15%/15% 分层抽样**（`StratifiedShuffleSplit`），所有节点特征与拓扑在训练时**可见**。

---

## 2. 模型与训练

### 2.1 HTGNN 主干（保持不变）

**层内三段聚合**（论文 Fig.2；式(4.1)–(4.16)）：  
1) **Intra‑relation**：同一个时间片按关系类型用 GAT 聚合；  
2) **Inter‑relation**：对不同关系学习权重并加权合成（实现为全局关系权重，与原仓库一致）；  
3) **Across‑time**：跨时间片的注意力聚合，使用正余弦位置编码；  
然后**门控残差**融合邻域与自特征；多层堆叠后将目标类型各时间片输出**求和**得最终表示。

### 2.2 本任务封装

- 对 `GO`/`reaction` 注入 `nn.Embedding` 并**在前向时**覆盖其 `t0~t35` 特征（占位特征被替换），然后调用 HTGNN 获取 **protein** 表示，接两层 MLP 得到 1 维 **logits**。输出未过 Sigmoid，损失用 **BCE with logits**。

### 2.3 训练与早停

- 配置：Adam，lr=5e‑3，weight decay=5e‑4，dropout=0.2，`n_layers=2`，`d_model=32`，`epochs=500`，`patience=50`（论文 §5.3 与本项目配置一致）。  
- 早停：监控**验证损失**，保存 `outputs/checkpoint.pt`；触发后加载最优参数做测试评估。

---

## 3. 评估与日志

- 仅在 **protein** 节点输出：**AUC、AP、ACC、BACC、F1(macro)**；并分别报告**正/负类 Precision/Recall**；每 10 个 epoch 打印一次（日志格式固定）。AUC/AP 对“单类 split”做 NaN 兼容；分类阈值 = 0.5。可视化包括验证期 5 张折线图与测试 **ROC/PR** 各 1 张。

- 训练前打印**Graph Report**（节点/标签/边计数，基础关系聚合；三划分规模与类内比例），格式严格与样例一致。

---

## 4. 与 HTGNN 论文/官方实现的一致性

- **方法机制**：Intra/Inter/Across‑time 三段联合建模 + 门控，层间堆叠与时间求和完全对齐（论文 Fig.2、式(4.1)–(4.16)）。  
- **构图策略**：时间后缀化关系名 `*_t{t}` 与官方数据管线一致（COVID/MAG）。  
- **训练细节**：与 §5.3 相同的优化器/学习率/权重衰减/dropout/层数/epoch/早停。

---

## 5. 复现要点 & 风险提示

- **设备选择**：若本机仅单卡/CPU，请在 `train.py` 顶部把 `DEVICE` 改成 `cuda:0` 或 `cpu`。  
- **timeset 端点**：唯一端点需等于 37，否则抛错；空 `timeset` 视为全时段。  
- **protein 特征**：`t0~t35` 任一缺失将报错（避免静默插值）。  
- **Undirected** 边会补反向；**Directed** 只保留指定方向。

---

## 6. 结论

本项目在**不改动 HTGNN 主干**的前提下，实现了面向自建异构时态图的**蛋白质重要性节点二分类**；训练流程、超参与论文配置对齐，日志/图表/报表满足输出要求，拿到 CSV 即可复现。
